name: Post issue guidance comment

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write

jobs:
  guide:
    runs-on: ubuntu-latest
    steps:
      - name: Post guide comment
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue = context.payload.issue;

            const title = issue.title || "";
            const labels = (issue.labels || [])
              .map(l => (typeof l === "string" ? l : l.name))
              .filter(Boolean);

            const isFeature = labels.includes("feature") || title.startsWith("üí° [FEATURE]");
            const isBug = labels.includes("bug") || title.startsWith("üêõ [BUG]");

            if (!isFeature && !isBug) return;

            const marker = isFeature ? "<!-- GUIDE:FEATURE -->" : "<!-- GUIDE:BUG -->";

            // Avoid duplicate comments: look for an existing guide comment
            const comments = await github.paginate(
              github.rest.issues.listComments,
              { owner, repo, issue_number: issue.number, per_page: 100 }
            );

            if (comments.some(c => (c.body || "").includes(marker))) return;

            const featureGuide = `${marker}

            <details>
            <summary><strong>Story point estimation guide</strong></summary>

            **Story points are relative (not hours).** Use them to express overall effort/complexity/uncertainty.

            **Use this as a guide for populating _Projects ‚Üí Estimate_ during Sprint Planning:**
            - **?**: not enough info to estimate (needs clarification/spike)
            - **¬Ω‚Äì1**: tiny, well understood, low risk
            - **2‚Äì3**: small, straightforward, some unknowns
            - **5**: medium, multiple steps, needs testing
            - **8**: large, design decisions / more moving parts
            - **13**: very large, high uncertainty ‚Äî consider splitting
            - **20/40/100**: too big/uncertain ‚Äî break down before committing
            - **‚àû**: unbounded/unestimable as written (re-scope)

            Further explanation: https://www.mountaingoatsoftware.com/blog/why-the-fibonacci-sequence-works-well-for-estimating
            </details>`.replace(/^ {12}/gm, "").trim();

            const bugGuide = `${marker}

            <details>
            <summary><strong>Bug report checklist</strong></summary>

            To make this bug easy to reproduce and verify:

            - **Expected vs actual**: what should happen vs what happened
            - **Repro steps**: minimal steps to reproduce
            - **Environment/version**: device/OS/app version/commit/build
            - **Evidence**: logs, screenshots, error messages
            - **Fix criteria**: how we‚Äôll know it‚Äôs fixed (ideally a regression test)

            Tip: if this blocks a current Feature/Epic, link it in the issue body or add it as a sub-issue.
            </details>`.replace(/^ {12}/gm, "").trim();

            const commentBody = isFeature ? featureGuide : bugGuide;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issue.number,
              body: commentBody
            });
